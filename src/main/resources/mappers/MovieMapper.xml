<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.babsang.megabox.mappers.IMovieMapper">

    <select id="selectMovieCommentByMid"
            resultType="dev.babsang.megabox.vos.movie.MovieCommentVo">
        select `index`         as `index`,
               user_id         as userId,
               movie_index     as mid,
               score           as score,
               recommend_point as recommendPoint,
               content         as content,
               written_on      as writtenOn,
               count(`index`)  as commentCnt
        from mg_movie.movie_comment
        where movie_index = #{mid}
        group by `index`
        limit 1
    </select>

    <select id="selectMovieCommentsByMid"
            resultType="dev.babsang.megabox.entities.movie.MovieCommentEntity">
        select `index`         as `index`,
               user_id         as userId,
               movie_index     as mid,
               score           as score,
               recommend_point as recommendPoint,
               content         as content,
               written_on      as writtenOn
        from mg_movie.movie_comment
        where movie_index = #{mid}
    </select>

    <select id="selectMovieByIndex" resultType="dev.babsang.megabox.entities.movie.MovieEntity">
        select `index`          as `index`,
               title            as title,
               title_en         as titleEn,
               release_date     as releaseDate,
               end_date         as endDate,
               summary          as summary,
               age_limit        as ageLimit,
               movie_state      as movieState,
               genre            as genre,
               director         as director,
               actor            as actor,
               running_time     as runnungTime,
               screen_type      as screenType,
               movie_poster     as moviePoster,
               background_image as backgroundImage,
               adult_price      as adultPrice,
               teenager_price   as teenagerPrice,
               etc_price        as etcPrice,
               score_avg as scoreAvg
        from mg_movie.movies
        where `index` = #{mid}
    </select>

    <select id="selectMovies" resultType="dev.babsang.megabox.entities.movie.MovieEntity">
        select `index`          as `index`,
               title            as title,
               title_en         as titleEn,
               release_date     as releaseDate,
               end_date         as endDate,
               summary          as summary,
               age_limit        as ageLimit,
               movie_state      as movieState,
               genre            as genre,
               director         as director,
               actor            as actor,
               running_time     as runningTime,
               screen_type      as screenTyoe,
               movie_poster     as moviePoster,
               background_image as backgroundImage,
               adult_price      as adultPrice,
               teenager_price   as teenagerPrice,
               etc_price        as etcPrice,
               score_avg        as scoreAvg
        from mg_movie.movies
    </select>

    <select id="selectCommingMovies" resultType="dev.babsang.megabox.entities.movie.MovieEntity">
        select `index`          as `index`,
               title            as title,
               title_en         as titleEn,
               release_date     as releaseDate,
               end_date         as endDate,
               summary          as summary,
               age_limit        as ageLimit,
               movie_state      as movieState,
               genre            as genre,
               director         as director,
               actor            as actor,
               running_time     as runningTime,
               screen_type      as screenTyoe,
               movie_poster     as moviePoster,
               background_image as backgroundImage,
               adult_price      as adultPrice,
               teenager_price   as teenagerPrice,
               etc_price        as etcPrice,
               score_avg        as scoreAvg
        from mg_movie.movies
        where movies.release_date > now();
    </select>

    <select id="selectMovieVo" resultType="dev.babsang.megabox.vos.movie.MovieVo">
        select movie.`index`          as `index`,
               movie.title            as title,
               movie.title_en         as titleEn,
               movie.release_date     as releaseDate,
               movie.end_date         as endDate,
               movie.summary          as summary,
               movie.age_limit        as ageLimit,
               movie.movie_state      as movieState,
               movie.genre            as genre,
               movie.director         as director,
               movie.actor            as actor,
               movie.running_time     as runningTime,
               movie.screen_type      as screenTyoe,
               movie.movie_poster     as moviePoster,
               movie.background_image as backgroundImage,
               movie.adult_price      as adultPrice,
               movie.teenager_price   as teenagerPrice,
               movie.etc_price        as etcPrice,
               movie.score_avg        as scoreAvg,
               count(booking.`index`) as totalAudience
        from mg_movie.movies as movie
                 left join mg_movie.screen_info as screenInfo on movie.index = screenInfo.movie_index
                 left join mg_movie.booking as booking on screenInfo.index = booking.screen_info_index
        where movie_index = #{mid}
    </select>

    <select id="selectBooking" resultType="dev.babsang.megabox.entities.movie.BookingEntity">
        select `index`           as `index`,
               screen_info_index as screenInfoIndex,
               user_id           as userId,
               seat_index        as seatIndex,
               payment           as payment
        from mg_movie.booking
    </select>

    <insert id="insertComment"
            useGeneratedKeys="true"
            keyProperty="index"
            keyColumn="index"
            parameterType="dev.babsang.megabox.entities.movie.MovieCommentEntity">
        insert into mg_movie.movie_comment(user_id, score, recommend_point, content, written_on, movie_index)
        values (#{userId}, #{score}, #{recommendPoint}, #{content},
                IFNULL(#{writtenOn}, DEFAULT(`written_on`)), #{mid})
    </insert>

</mapper>
